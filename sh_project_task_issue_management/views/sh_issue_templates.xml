<?xml version='1.0' encoding='utf-8'?>
<odoo>

    <template id="sh_portal_layout" name="Portal layout: Issue menu entry"
        inherit_id="portal.portal_breadcrumbs">
        <xpath expr="//ol[hasclass('o_portal_submenu')]" position="inside" priority="50">
            <li t-if="page_name == 'issue' or issue" class="col-lg-2"
                t-attf-class="breadcrumb-item #{'active ' if not issue else ''}">
                <a t-if="issue" t-attf-href="/my/issues?{{ keep_query() }}">Issues</a>
                <t t-else="">Issues</t>
            </li>
            <li t-if="issue" class="breadcrumb-item active text-truncate">
                <span t-field="issue.name" />
            </li>
        </xpath>
    </template>

    <template id="sh_portal_my_home" name="Show Issues" inherit_id="project.portal_my_home">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="inside">
            <t t-call="portal.portal_docs_entry">
                <t t-set="title">Issues</t>
                <t t-set="url" t-value="'/my/issues'" />
                <t t-set="placeholder_count" t-value="'issue_count'" />
            </t>
        </xpath>
    </template>

    <template id="portal_my_issues" name="My Issues">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True" />

            <t t-call="portal.portal_searchbar">
                <t t-set="title">Issues</t>
            </t>
            <t t-if="not grouped_issues">
                <div>
                    There are currently no issues for your account.
                </div>
            </t>
            <t t-call="sh_project_task_issue_management.portal_issues_list" />
        </t>
    </template>

    <template id="portal_issues_list" name="issues List">
        <t t-if="grouped_issues">
            <t t-call="portal.portal_table">
                <t t-foreach="grouped_issues" t-as="issues">
                    <thead>
                        <tr t-attf-class="{{'thead-light' if not groupby == 'none' else ''}}">
                            <th t-if="groupby == 'none'">Name</th>
                            <th t-if="groupby == 'project'">
                                <em class="font-weight-normal text-muted">
                                    <span t-field="issues[0].sudo().sh_project_id.label_tasks" />
                                    for project: </em>
                                <span t-field="issues[0].sudo().sh_project_id.name" />
                            </th>
                            <th t-if="groupby == 'stage'">
                                <em class="font-weight-normal text-muted">
                                    <span t-field="issues[0].sudo().sh_project_id.label_tasks" /> in
                                    stage: </em>
                                <span class="text-truncate"
                                    t-field="issues[0].sudo().sh_stage_id.name" />
                            </th>
                            <th t-if="groupby != 'project'">Project</th>
                            <th t-if="groupby != 'stage'">Stage</th>
                            <th class="text-center">Ref</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="issues" t-as="issue">
                            <tr>
                                <td class="text-left">
                                    <a t-attf-href="/my/#{issue_url}/#{issue.id}?{{ keep_query() }}">
                                        <span t-field="issue.name" />
                                    </a>
                                </td>
                                <td t-if="groupby != 'project'">
                                    <span
                                        class="badge rounded-pill text-bg-info mw-100 text-truncate"
                                        title="Current project of the issue"
                                        t-esc="issue.sh_project_id.name" />
                                </td>

                                <td t-if="groupby != 'stage'">
                                    <span t-attf-class="badge rounded-pill #{'text-bg-primary'}"
                                        title="Current stage of the issue"
                                        t-esc="issue.sh_stage_id.name" />
                                </td>
                                <td class="text-center"> #<span t-field="issue.id" />
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </t>
            </t>
        </t>
    </template>

    <!-- My Issue Template -->
    <template id="portal_my_issue" name="My Issue">
        <t t-call="portal.portal_layout">

            <t t-call="portal.portal_record_layout">
                <t t-set="card_header">
                    <div class="row no-gutters">
                        <div class="col-12">
                            <h5 class="d-flex mb-1 mb-md-0 row">
                                <div class="col-9">
                                    <span t-field="issue.name" class="text-truncate" />
                                    <small class="text-muted d-none d-md-inline"> (#<span
                                            t-field="issue.id" />) </small>
                                </div>
                                <div class="col-3 text-end">
                                    <small class="text-end">Stage:</small>
                                    <span t-field="issue.sh_stage_id.name"
                                        class=" badge rounded-pill text-bg-info"
                                        title="Current stage of this issue" />
                                </div>
                            </h5>
                        </div>
                    </div>
                </t>
                <t t-set="card_body">
                    <div class="row mb-4">
                        <div class="col-12 col-md-6">
                            <div t-if="project_accessible">
                                <strong>Project:</strong>
                                <a t-attf-href="/my/project/#{task.project_id.id}"
                                    t-field="issue.sh_project_id" />
                            </div>
                            <div t-else="">
                                <strong>Project:</strong>
                                <a t-field="issue.sh_project_id" />
                            </div>
                            <div>
                                <strong>Date:</strong>
                                <span t-field="issue.create_date" t-options='{"widget": "date"}' />
                            </div>

                        </div>
                        <div class="col-12 col-md-6" name="portal_my_task_second_column"></div>
                    </div>

                    <div class="row" t-if="issue.sh_user_ids or issue.sh_partner_id">
                        <div class=" col-md-6 col-12 pb-2" t-if="issue.sh_user_ids">
                            <strong>Assigned To</strong>
                            <div class="row">
                                <t t-foreach="issue.sh_user_ids" t-as="user">
                                    <div class="col d-flex align-items-center flex-grow-0 pr-3">
                                        <img class="rounded-circle mt-1 o_portal_contact_img"
                                            t-att-src="image_data_uri(user.avatar_1024)"
                                            alt="Contact" />
                                    </div>
                                    <div class="col pl-md-0">
                                        <div t-esc="user"
                                            t-options='{"widget": "contact", "fields": ["name"]}' />
                                        <a t-attf-href="mailto:{{user.email}}" t-if="user.email">
                                            <div t-esc="user"
                                                t-options='{"widget": "contact", "fields": ["email"]}' />
                                        </a>
                                        <a t-attf-href="tel:{{user.phone}}" t-if="user.phone">
                                            <div t-esc="user"
                                                t-options='{"widget": "contact", "fields": ["phone"]}' />
                                        </a>
                                    </div>
                                </t>
                            </div>
                        </div>
                        <div class="col-md-6 col-12 pb-2" t-if="issue.sh_partner_id">
                            <strong>Reported By</strong>
                            <div class="row">
                                <div class="col d-flex align-items-center flex-grow-0 pr-3">
                                    <img class="rounded-circle mt-1 o_portal_contact_img"
                                        t-att-src="image_data_uri(issue.sh_partner_id.avatar_1024)"
                                        alt="Contact" />
                                </div>
                                <div class="col pl-md-0">
                                    <div t-field="issue.sh_partner_id"
                                        t-options='{"widget": "contact", "fields": ["name"]}' />
                                    <a t-attf-href="mailto:{{issue.sh_partner_id.email}}"
                                        t-if="issue.sh_partner_id.email">
                                        <div t-field="issue.sh_partner_id"
                                            t-options='{"widget": "contact", "fields": ["email"]}' />
                                    </a>
                                    <a t-attf-href="tel:{{issue.sh_partner_id.phone}}"
                                        t-if="issue.sh_partner_id.phone">
                                        <div t-field="issue.sh_partner_id"
                                            t-options='{"widget": "contact", "fields": ["phone"]}' />
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 col-md-6">
                            <strong>Issue Type :</strong>
                            <br></br>
                            <div
                                style="padding:10px; background:#e9ecef; margin-top:10px; border-radius:5px;">
                                <t t-esc="issue.sh_issue_type_id.name" />
                            </div>
                        </div>
                        <div class="col-12 col-md-6" t-if="issue.sh_task_id">
                            <strong>Task :</strong>
                            <br></br>
                            <div
                                style="padding:10px; background:#e9ecef; margin-top:10px; border-radius:5px;">
                                <t t-esc="issue.sh_task_id.name" />
                            </div>
                        </div>
                    </div>
                    <hr />
                    <div class="row">
                        <div class="col-12" t-if="issue.sh_description">
                            <strong>Description</strong>
                            <t t-esc="issue.sh_description" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12" t-if="issue.sh_additional_comment">
                            <strong>Additional Comment</strong>
                            <t t-esc="issue.sh_additional_comment" />
                        </div>
                    </div>
                </t>
            </t>
            <div class="mt32">
                <h4>
                    <strong>Message and communication history</strong>
                </h4>
                <t t-call="portal.message_thread">
                    <t t-set="object" t-value="issue" />
                    <t t-set="token" t-value="issue.access_token" />
                    <t t-set="pid" t-value="pid" />
                    <t t-set="hash" t-value="hash" />
                </t>
            </div>
        </t>
    </template>

    <template id="create_issue_template" name="Create Issues" inherit_id="project.portal_my_task">
        <xpath expr="//div[hasclass('float-end')]" position="after">
            <div class="row">
                <div class="col-10"></div>
                <div class="col-2">
                    <button type="button" class="btn btn-primary btn-sm js_cls_issue_model"
                        id="sh_open_create_issue" t-att-data-task-id="task.id"
                        t-att-data-project-id="task.project_id.id"
                        t-att-data-partner-id="request.env.user.partner_id.id"
                        t-att-data-user-id="request.env.user.id"
                        t-att-data-company-id="request.env.user.company_id.id">
                        Create Issue
                    </button>
                </div>
            </div>
        </xpath>
    </template>

</odoo>